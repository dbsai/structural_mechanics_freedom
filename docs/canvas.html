<!DOCTYPE html>

<html>
<head>
  <title>canvas.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="body.html">
                  body.js
                </a>
              
                
                <a class="source" href="calculate.html">
                  calculate.js
                </a>
              
                
                <a class="source" href="calculatem.html">
                  calculatem.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  canvas.js
                </a>
              
                
                <a class="source" href="canvasdraw.html">
                  canvasdraw.js
                </a>
              
                
                <a class="source" href="componentbar.html">
                  componentbar.js
                </a>
              
                
                <a class="source" href="draw.html">
                  draw.js
                </a>
              
                
                <a class="source" href="drawc.html">
                  drawc.js
                </a>
              
                
                <a class="source" href="factory.html">
                  factory.js
                </a>
              
                
                <a class="source" href="inputbar.html">
                  inputbar.js
                </a>
              
                
                <a class="source" href="linkedbar.html">
                  linkedbar.js
                </a>
              
                
                <a class="source" href="linkedbarm.html">
                  linkedbarm.js
                </a>
              
                
                <a class="source" href="nomo.html">
                  nomo.js
                </a>
              
                
                <a class="source" href="resultbox.html">
                  resultbox.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>canvas.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">'app/collection/drawc'</span>,<span class="hljs-string">'./canvasdraw'</span>,<span class="hljs-string">'app/model/factory'</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">drawC,canvasdraw,factory</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>绘图区域</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>




  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> (Backbone.View.extend({

    el: $(<span class="hljs-string">"#canvaswrap"</span>),

    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>开闭拖动</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.listenTo(factory, <span class="hljs-string">"change:type"</span>, <span class="hljs-keyword">this</span>.movable)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>绘图数据已送达：监听drawC collection 加入新元素事件</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.listenTo(drawC, <span class="hljs-string">"add"</span>, <span class="hljs-keyword">this</span>.presolve)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>为了便于引用，定义canvas属性</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.canvas = <span class="hljs-keyword">this</span>.$el.find(<span class="hljs-string">"canvas"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>引入绘图库</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.drawlib = canvasdraw.draw()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>定义工厂，引入每个加工完成的元素</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.factory = factory
    },
    
    presolve: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newmodel</span>) </span>{
      <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>
        , models = drawC.models
        , l = models.length</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>最近一次的绘制点作为下一根杆的起始点</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , xy = newmodel.get(<span class="hljs-string">"category"</span>) == <span class="hljs-string">"constr"</span> ? {
          <span class="hljs-string">"x"</span>: newmodel.get(<span class="hljs-string">"x"</span>)
          , <span class="hljs-string">"y"</span>: newmodel.get(<span class="hljs-string">"y"</span>)
        } : {
          <span class="hljs-string">"x"</span>: newmodel.get(<span class="hljs-string">"x2"</span>)
          , <span class="hljs-string">"y"</span>: newmodel.get(<span class="hljs-string">"y2"</span>)
        }

      <span class="hljs-keyword">this</span>.factory.set(xy)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>绘制</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.drawlib[newmodel.get(<span class="hljs-string">"type"</span>)](newmodel)
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>初等集合的计算库（点到直线的距离、点到点的距离，斜率的近似…）</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tools: {
      connect: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connect1, order1, connect2, order2</span>) </span>{
        <span class="hljs-keyword">if</span> (!_.contains(connect1, order2)) connect1.push(order2)
        <span class="hljs-keyword">if</span> (!_.contains(connect2, order1)) connect2.push(order1)
      }
      , p2pdistance: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x1, y1, x2, y2,r</span>) </span>{
        <span class="hljs-keyword">if</span> (x1 == <span class="hljs-literal">null</span> || y1 == <span class="hljs-literal">null</span> || x2 == <span class="hljs-literal">null</span> || y2 == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">Infinity</span>

        <span class="hljs-keyword">if</span> (r == <span class="hljs-string">"x"</span>){
          <span class="hljs-built_in">console</span>.log(x1 + <span class="hljs-string">" "</span> + x2 + <span class="hljs-string">" "</span> + y1 + <span class="hljs-string">" "</span> + y2)
          <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1)))
        }

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))
      }
      , p2ldistance: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k, b, newx, newy</span>) </span>{
       
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.abs((newx - newy / k + b / k) / <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1</span> + <span class="hljs-number">1</span> / (k * k)))
      }
      , isp2l: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, x2, y2, k, b, newx, newy, d</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.region(newx, newy, x, y, x2, y2, d + <span class="hljs-number">2</span>, d + <span class="hljs-number">2</span>) &amp;&amp; <span class="hljs-keyword">this</span>.p2ldistance(k, b, newx, newy) &lt;= d + <span class="hljs-number">2</span>
      }
      , b2bhead: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, x2, y2, newx, newy, newx2, newy2, d,r</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.p2pdistance(x, y, newx, newy,r) &lt;= d ||
          <span class="hljs-keyword">this</span>.p2pdistance(x2, y2, newx, newy,r) &lt;= d ||
          <span class="hljs-keyword">this</span>.p2pdistance(x, y, newx2, newy2,r) &lt;= d ||
          <span class="hljs-keyword">this</span>.p2pdistance(x2, y2, newx2, newy2,r) &lt;= d
      }
      , b2bhead_p: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, x2, y2, newx, newy, newx2, newy2, d</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.p2pdistance(x, y, newx, newy) &lt;= d||<span class="hljs-keyword">this</span>.p2pdistance(x, y, newx2, newy2) &lt;= d){ 

          <span class="hljs-keyword">return</span> (<span class="hljs-string">"x"</span> + x + <span class="hljs-string">"y"</span> + y)
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.p2pdistance(x2, y2, newx, newy) &lt;= d||<span class="hljs-keyword">this</span>.p2pdistance(x2, y2, newx2, newy2) &lt;= d) {          

          <span class="hljs-keyword">return</span> (<span class="hljs-string">"x"</span> + x2 + <span class="hljs-string">"y"</span> + y2)
        } <span class="hljs-keyword">else</span> {

          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
      } 
      , region: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, regionx1, regiony1, regionx2, regiony2, dx, dy</span>) </span>{

        <span class="hljs-keyword">var</span> maxX = regionx1 &gt;= regionx2 ? regionx1 : regionx2
          , minX = maxX == regionx1 ? regionx2 : regionx1
          , maxY = regiony1 &gt;= regiony2 ? regiony1 : regiony2
          , minY = maxY == regiony1 ? regiony2 : regiony1


        <span class="hljs-keyword">if</span> (_.isUndefined(maxX)||_.isUndefined(maxX)||_.isUndefined(maxX)||_.isUndefined(maxX)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>        

        <span class="hljs-keyword">return</span> x &lt;= maxX + dx &amp;&amp; y &lt;= maxY + dy &amp;&amp; x &gt;= minX - dx &amp;&amp; y &gt;= minY - dy
      }
      , coorSet: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">factory, x, y, angle, barlength</span>) </span>{
        <span class="hljs-keyword">if</span> (factory.get(<span class="hljs-string">"x"</span>) &amp;&amp; factory.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"linebar"</span>) {      
          factory.set({
            <span class="hljs-string">"x2"</span>: x
            , <span class="hljs-string">"y2"</span>: y
          })
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (!(factory.get(<span class="hljs-string">"x"</span>)&amp;&amp;factory.get(<span class="hljs-string">"category"</span>) == <span class="hljs-string">"constr"</span>)) {
            factory.set({
              <span class="hljs-string">"x"</span>: x
              , <span class="hljs-string">"y"</span>: y
            })
          }

          <span class="hljs-keyword">if</span> (factory.get(<span class="hljs-string">"type"</span>) == <span class="hljs-string">"linebar"</span>&amp;&amp;!_.isUndefined(angle)&amp;&amp;barlength){
            <span class="hljs-keyword">var</span> kx = <span class="hljs-built_in">Math</span>.cos(<span class="hljs-built_in">Math</span>.PI * angle / <span class="hljs-number">180</span>)
              , ky = <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Math</span>.PI * angle / <span class="hljs-number">180</span>)

            factory.set({
              <span class="hljs-string">"x2"</span>: <span class="hljs-built_in">Number</span>((x + kx*barlength).toFixed(<span class="hljs-number">0</span>))
              , <span class="hljs-string">"y2"</span>: <span class="hljs-built_in">Number</span>((y + ky*barlength).toFixed(<span class="hljs-number">0</span>))
            })
          }
        }
      }
      , kSimilar: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k</span>)</span>{
        <span class="hljs-keyword">var</span> k = <span class="hljs-built_in">Math</span>.abs(k) &gt; <span class="hljs-number">9999</span> ? (k &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">-10000</span> : <span class="hljs-number">10000</span>) : k
          , k = <span class="hljs-built_in">Math</span>.abs(k) &lt; <span class="hljs-number">0.0001</span> ? <span class="hljs-number">0.0001</span> : k

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(k.toFixed(<span class="hljs-number">4</span>))
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>点击canvas画布触发事件</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    events: {
      <span class="hljs-string">"click canvas"</span>: <span class="hljs-string">"setCoor"</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>向工厂中运送绘图的初始数据，该数据不直接用于绘制</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setCoor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e, X, Y</span>) </span>{

      <span class="hljs-keyword">if</span> ($(<span class="hljs-string">"canvas"</span>).hasClass(<span class="hljs-string">"moving"</span>)) <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">if</span> (drawC.models.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"order"</span>, <span class="hljs-number">0</span>)

      <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"order"</span>, drawC.last().get(<span class="hljs-string">"order"</span>) + <span class="hljs-number">1</span>)

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"connects"</span>)) <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"connects"</span>, [])
      
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"bodys"</span>)) <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"bodys"</span>, [])
            
      <span class="hljs-keyword">var</span> leftpos = <span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"left"</span>).indexOf(<span class="hljs-string">"px"</span>)
        , toppos = <span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"top"</span>).indexOf(<span class="hljs-string">"px"</span>)
        , borderpos = <span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"border-width"</span>).indexOf(<span class="hljs-string">"px"</span>)
        , angle = <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">Number</span>($(<span class="hljs-string">"#angle"</span>).val()).toFixed(<span class="hljs-number">0</span>))
        , bodys = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"bodys"</span>)
        , barlength = <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">Number</span>($(<span class="hljs-string">"#line"</span>).val()).toFixed(<span class="hljs-number">0</span>))
        , borderwidth = <span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"border-width"</span>).slice(<span class="hljs-number">0</span>, borderpos))</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>画布的left偏移等于其父元素的left偏移加上边框宽度</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , left = <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"left"</span>).slice(<span class="hljs-number">0</span>, leftpos)).toFixed(<span class="hljs-number">0</span>)) + borderwidth
        , top = <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">Number</span>(<span class="hljs-keyword">this</span>.$el.css(<span class="hljs-string">"top"</span>).slice(<span class="hljs-number">0</span>, toppos)).toFixed(<span class="hljs-number">0</span>)) + borderwidth</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>此次点击的坐标</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , X = e.type == <span class="hljs-string">"click"</span> ? e.pageX - <span class="hljs-keyword">this</span>.canvas.position().left - left : X
        , Y = e.type == <span class="hljs-string">"click"</span> ? e.pageY - <span class="hljs-keyword">this</span>.canvas.position().top - top : Y
        , newx = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"x"</span>)
        , newy = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"y"</span>)
        , neworder = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"order"</span>)
        , newtype = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"type"</span>)
        , newcategory = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"category"</span>)
        , newconnects = <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"connects"</span>)
        , coinarr = []</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>定向铰和固定端连接在n根杆上</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , bartime = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>点击与n跟杆接近</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , n = <span class="hljs-number">0</span>
        , pointx, pointy</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>约束端部重合</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , coincide = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>杆端部重合</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        , barcide = <span class="hljs-number">0</span>
        , barcidearr = []
        , preventdraw = <span class="hljs-literal">false</span>
     
      <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"angle"</span>, angle)

      <span class="hljs-keyword">if</span> (
        _.some(drawC.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
          <span class="hljs-keyword">var</span> category = model.get(<span class="hljs-string">"category"</span>)
            , type = model.get(<span class="hljs-string">"type"</span>)
            , x1 = model.get(<span class="hljs-string">"x"</span>)
            , x2 = model.get(<span class="hljs-string">"x2"</span>)
            , y1 = model.get(<span class="hljs-string">"y"</span>)
            , y2 = model.get(<span class="hljs-string">"y2"</span>)
          
          <span class="hljs-keyword">if</span> (category == <span class="hljs-string">"constr"</span> &amp;&amp; newcategory == <span class="hljs-string">"constr"</span> &amp;&amp; <span class="hljs-keyword">this</span>.tools.p2pdistance(x1, y1, X, Y) &lt; <span class="hljs-number">10</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>防止两约束重合</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newcategory == <span class="hljs-string">"bar"</span> &amp;&amp;
            (type == <span class="hljs-string">"gdd"</span> || type == <span class="hljs-string">"dxj"</span>) &amp;&amp;
            (
              <span class="hljs-keyword">this</span>.tools.p2pdistance(X, Y, x1, y1) &lt; <span class="hljs-number">5</span> ||
              <span class="hljs-keyword">this</span>.tools.p2pdistance(newx, newy, x1, y1) &lt; <span class="hljs-number">5</span>
            ) &amp;&amp; model.get(<span class="hljs-string">"connects"</span>).length &gt; <span class="hljs-number">0</span>
          ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>防止多根杆连接在定向铰和固定端上</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (model.get(<span class="hljs-string">"category"</span>) == <span class="hljs-string">"bar"</span> &amp;&amp;
            (newtype == <span class="hljs-string">"gdd"</span> || newtype == <span class="hljs-string">"dxj"</span>) &amp;&amp;
            (
              <span class="hljs-keyword">this</span>.tools.p2pdistance(X, Y, x1, y1) &lt; <span class="hljs-number">5</span> || <span class="hljs-keyword">this</span>.tools.p2pdistance(X, Y, x2, y2) &lt; <span class="hljs-number">5</span>
            )
          ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>防止定向铰和固定端连接在多根杆上</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bartime++

            <span class="hljs-keyword">if</span> (bartime &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
          }
        }.bind(<span class="hljs-keyword">this</span>))) <span class="hljs-keyword">return</span>
      
      _.each(drawC.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, index, list</span>) </span>{
        <span class="hljs-keyword">var</span> k = model.get(<span class="hljs-string">"k"</span>)
          , b = model.get(<span class="hljs-string">"b"</span>)
          , x1 = model.get(<span class="hljs-string">"x"</span>)
          , x2 = model.get(<span class="hljs-string">"x2"</span>)
          , y1 = model.get(<span class="hljs-string">"y"</span>)
          , y2 = model.get(<span class="hljs-string">"y2"</span>)
          , d1 = <span class="hljs-keyword">this</span>.tools.p2pdistance(x1, y1, X, Y) &lt; <span class="hljs-number">5</span>
          , d2 = model.get(<span class="hljs-string">"x2"</span>) ? <span class="hljs-keyword">this</span>.tools.p2pdistance(x2, y2, X, Y) &lt; <span class="hljs-number">5</span> : <span class="hljs-literal">undefined</span>
          , order = model.get(<span class="hljs-string">"order"</span>)
          , category = model.get(<span class="hljs-string">"category"</span>)
          , connects = model.get(<span class="hljs-string">"connects"</span>)
          , mbodys = model.get(<span class="hljs-string">"bodys"</span>)
          , type = model.get(<span class="hljs-string">"type"</span>)
          , coinx = d1 ? x1 : x2
          , coiny = d1 ? y1 : y2</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>处理由于约束存在而造成的杆件断开</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          , commonconnects
          , notbarbody = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>约束与杆端部重合</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ((d1 || d2) &amp;&amp; newcategory == <span class="hljs-string">"constr"</span>) {

          <span class="hljs-keyword">if</span> (!coincide) {
            
            <span class="hljs-keyword">this</span>.tools.coorSet(<span class="hljs-keyword">this</span>.factory, coinx, coiny)

            coincide = <span class="hljs-literal">true</span>
          }

          <span class="hljs-keyword">this</span>.tools.connect(connects, order, newconnects, neworder)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>切断杆</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (coincide &amp;&amp; index == list.length - <span class="hljs-number">1</span>) {

          _.each(newconnects, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connect</span>) </span>{
            <span class="hljs-keyword">var</span> connectmodel = drawC.at(connect)
              , preconnects = _.filter(newconnects, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">preconnect</span>) </span>{
                <span class="hljs-keyword">return</span> preconnect !== connect
              })

            connectmodel.set(<span class="hljs-string">"connects"</span>, _.filter(connectmodel.get(<span class="hljs-string">"connects"</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">currentconnect</span>) </span>{
              <span class="hljs-keyword">return</span> !_.contains(preconnects, currentconnect)
            }))
          })
        }

        <span class="hljs-keyword">if</span> (newcategory == <span class="hljs-string">"bar"</span>) {

          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"x"</span>) &amp;&amp;bodys.length == <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">var</span> anodj = _.filter(drawC.models,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>)</span>{

              <span class="hljs-keyword">var</span> m = m.toJSON()

              <span class="hljs-keyword">if</span> (m.type == <span class="hljs-string">"linebar"</span>){
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
              }

              <span class="hljs-keyword">return</span> (m.x == <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"x"</span>) &amp;&amp;m.y == <span class="hljs-keyword">this</span>.factory.get(<span class="hljs-string">"y"</span>)) || <span class="hljs-keyword">this</span>.tools.b2bhead(m.x, m.y, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, X, Y, <span class="hljs-number">5</span>)

            }.bind(<span class="hljs-keyword">this</span>))
            
            <span class="hljs-keyword">if</span> (anodj.length == <span class="hljs-number">1</span>) {

              <span class="hljs-keyword">var</span> djbody = anodj[<span class="hljs-number">0</span>].get(<span class="hljs-string">"bodys"</span>)[<span class="hljs-number">0</span>]
          
              <span class="hljs-keyword">if</span> (!_.isUndefined(djbody)){
                bodys.push(djbody)   
              }               
            }              
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>杆端部相连</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tools.b2bhead(x1, y1, x2, y2, newx, newy, X, Y, <span class="hljs-number">5</span>)) {

            <span class="hljs-keyword">var</span> barp = <span class="hljs-keyword">this</span>.tools.b2bhead_p(x1, y1, x2, y2, newx, newy, X, Y, <span class="hljs-number">5</span>)

            <span class="hljs-keyword">if</span> (!_.contains(barcidearr,barp)&amp;&amp; type == <span class="hljs-string">"linebar"</span>) {
              barcidearr.push(barp)
              barcide++    
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>bar和newbar连在了同一个约束上，那不添加到彼此的连接件上</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (category == <span class="hljs-string">"bar"</span> &amp;&amp;
              _.some(connects, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connect</span>) </span>{
                <span class="hljs-keyword">if</span> (!drawC.at(connect)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

                <span class="hljs-keyword">var</span> category = drawC.at(connect).get(<span class="hljs-string">"category"</span>)
                  , x1 = drawC.at(connect).get(<span class="hljs-string">"x"</span>)
                  , y1 = drawC.at(connect).get(<span class="hljs-string">"y"</span>)

                <span class="hljs-keyword">if</span> (category == <span class="hljs-string">"constr"</span> &amp;&amp; <span class="hljs-keyword">this</span>.tools.b2bhead(x1, y1, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, newx, newy, X, Y, <span class="hljs-number">0</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
              }.bind(<span class="hljs-keyword">this</span>))
            ) <span class="hljs-keyword">return</span>

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tools.b2bhead(x1, y1, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, X, Y, <span class="hljs-number">5</span>)) {          

              X = x1  
              Y = y1
              notbarbody = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>杆端连接的是链接在杆身上的约束</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"dj"</span> &amp;&amp;mbodys.length &gt; <span class="hljs-number">0</span> &amp;&amp;bodys.length &lt; <span class="hljs-number">2</span>) bodys.push(mbodys[<span class="hljs-number">0</span>])                

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tools.b2bhead(x2, y2, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, X, Y, <span class="hljs-number">5</span>)) {
              
              X = x2
              Y = y2    
              notbarbody = <span class="hljs-literal">true</span>
            }

            <span class="hljs-keyword">this</span>.tools.connect(connects, order, newconnects, neworder)
            <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"connects"</span>, newconnects)
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>杆端部重合</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (barcide &gt;= <span class="hljs-number">2</span>){
          <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"bodys"</span>,[])
          <span class="hljs-keyword">return</span>
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>点到杆的距离 作用域与值域范围 约束端部重合 </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tools.p2ldistance(k, b, X, Y) &gt; <span class="hljs-number">4</span> || 
          !<span class="hljs-keyword">this</span>.tools.region(X, Y, x1, y1, x2, y2, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>) ||
          coincide || (barcide == <span class="hljs-number">1</span>&amp;&amp; _.isUndefined(newx))) <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>垂线交点坐标 </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pointx = <span class="hljs-built_in">Number</span>(((Y + X / k - b) / (k + <span class="hljs-number">1</span> / k)).toFixed(<span class="hljs-number">0</span>))
        pointy = <span class="hljs-built_in">Number</span>((pointx * k + b).toFixed(<span class="hljs-number">0</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>杆身相连</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (newcategory == <span class="hljs-string">"bar"</span>&amp;&amp; !notbarbody) {
        
          X = pointx
          Y = pointy</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p> 补丁：line的order比constr靠前，coincide尚未设置为true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (!((X == x1&amp;&amp; Y == y1)|| (X == x2&amp;&amp; Y == y2))) {
       
            bodys.push({
              p : <span class="hljs-string">"x"</span> + X + <span class="hljs-string">"y"</span> + Y
              , p1: <span class="hljs-string">"x"</span> + x1 + <span class="hljs-string">"y"</span> + y1
              , p2 : <span class="hljs-string">"x"</span> + x2 + <span class="hljs-string">"y"</span> + y2
            })

            <span class="hljs-keyword">this</span>.factory.set(<span class="hljs-string">"bodys"</span>,bodys)

            <span class="hljs-keyword">this</span>.tools.connect(connects, order, newconnects, neworder)
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>约束与杆身连接 偏移约束</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_.contains([<span class="hljs-string">"gdj"</span>, <span class="hljs-string">"hdj"</span>, <span class="hljs-string">"dj"</span>], newtype)) {

          n++

          <span class="hljs-keyword">var</span> dx = <span class="hljs-built_in">Number</span>((<span class="hljs-number">6</span> / <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1</span> + (<span class="hljs-number">-1</span> / k) * (<span class="hljs-number">-1</span> / k))).toFixed(<span class="hljs-number">0</span>))
            , dy = <span class="hljs-built_in">Number</span>((<span class="hljs-number">6</span> * (<span class="hljs-number">-1</span> / k) / <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">1</span> + (<span class="hljs-number">-1</span> / k) * (<span class="hljs-number">-1</span> / k))).toFixed(<span class="hljs-number">0</span>))

          X = pointx &gt; X ? pointx - dx : pointx + dx
          Y = pointy &gt; Y ? pointy - dy : pointy + dy

          bodys.push({
            p : <span class="hljs-string">"x"</span> + X + <span class="hljs-string">"y"</span> + Y
            , p1: <span class="hljs-string">"x"</span> + x1 + <span class="hljs-string">"y"</span> + y1
            , p2 : <span class="hljs-string">"x"</span> + x2 + <span class="hljs-string">"y"</span> + y2
          })

          <span class="hljs-keyword">this</span>.tools.connect(connects, order, newconnects, neworder)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>防止定向支座和固定端与杆身相连</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (_.contains([<span class="hljs-string">"gdd"</span>, <span class="hljs-string">"dxj"</span>], newtype)) preventdraw = <span class="hljs-literal">true</span>

      }.bind(<span class="hljs-keyword">this</span>))
      
      <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">1</span> || preventdraw) <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">this</span>.tools.coorSet(<span class="hljs-keyword">this</span>.factory, X, Y, angle, barlength)

      <span class="hljs-keyword">this</span>.factory.drawelement()
    },

    movable: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">index, value</span>) </span>{
      <span class="hljs-keyword">if</span> (value == <span class="hljs-string">"move"</span>) {
        <span class="hljs-keyword">this</span>.canvas.draggable({
          disabled: <span class="hljs-literal">false</span>
        })
        
        <span class="hljs-keyword">this</span>.canvas.css({
          cursor: <span class="hljs-string">"-moz-grab"</span>
          , cursor: <span class="hljs-string">"-webkit-grab"</span>
        })
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.canvas.draggable({
          disabled: <span class="hljs-literal">true</span>
        })

        <span class="hljs-keyword">this</span>.canvas.css({
          cursor: <span class="hljs-string">"crosshair"</span>
        })
      }
    }

  }))()
})</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
