<!DOCTYPE html>

<html>
<head>
  <title>factory.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="body.html">
                  body.js
                </a>
              
                
                <a class="source" href="calculate.html">
                  calculate.js
                </a>
              
                
                <a class="source" href="calculatem.html">
                  calculatem.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  canvas.js
                </a>
              
                
                <a class="source" href="canvasdraw.html">
                  canvasdraw.js
                </a>
              
                
                <a class="source" href="componentbar.html">
                  componentbar.js
                </a>
              
                
                <a class="source" href="draw.html">
                  draw.js
                </a>
              
                
                <a class="source" href="drawc.html">
                  drawc.js
                </a>
              
                
                <a class="source" href="factory.html">
                  factory.js
                </a>
              
                
                <a class="source" href="inputbar.html">
                  inputbar.js
                </a>
              
                
                <a class="source" href="linkedbar.html">
                  linkedbar.js
                </a>
              
                
                <a class="source" href="linkedbarm.html">
                  linkedbarm.js
                </a>
              
                
                <a class="source" href="nomo.html">
                  nomo.js
                </a>
              
                
                <a class="source" href="resultbox.html">
                  resultbox.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>factory.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">'app/collection/drawc'</span>,<span class="hljs-string">'app/collection/linkedbarc'</span>,<span class="hljs-string">'./nomo'</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">drawC, linkedbarC,nomoM</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>将零散的数据组装起来的工程</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> (Backbone.Model.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>初始数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    defaults: {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"gdj"</span>
      , <span class="hljs-string">"category"</span>: <span class="hljs-string">"constr"</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>不同类型构件出厂前必须有的数据    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    georule: {
      <span class="hljs-string">"constr"</span>: [<span class="hljs-string">"x"</span>, <span class="hljs-string">"y"</span>, <span class="hljs-string">"angle"</span>, <span class="hljs-string">"order"</span>, <span class="hljs-string">"connects"</span>,<span class="hljs-string">"bodys"</span>]
      , <span class="hljs-string">"bar"</span>: [<span class="hljs-string">"x"</span>, <span class="hljs-string">"y"</span>, <span class="hljs-string">"x2"</span>, <span class="hljs-string">"y2"</span>, <span class="hljs-string">"order"</span>, <span class="hljs-string">"connects"</span>,<span class="hljs-string">"bodys"</span>]
      , <span class="hljs-string">"other"</span>: []
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>定义构件的类型</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    newrule: {
      <span class="hljs-string">"dj"</span>: <span class="hljs-string">"constr"</span>
      , <span class="hljs-string">"gdj"</span>: <span class="hljs-string">"constr"</span>
      , <span class="hljs-string">"hdj"</span>: <span class="hljs-string">"constr"</span>
      , <span class="hljs-string">"gdd"</span>: <span class="hljs-string">"constr"</span>
      , <span class="hljs-string">"dxj"</span>: <span class="hljs-string">"constr"</span>
      , <span class="hljs-string">"linebar"</span>: <span class="hljs-string">"bar"</span>
      , <span class="hljs-string">"move"</span>: <span class="hljs-string">"other"</span>
      , <span class="hljs-string">"mirror"</span>: <span class="hljs-string">"constr"</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>类型改变时，清除之前的数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{      
      <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"change:type"</span>, <span class="hljs-keyword">this</span>.clearAtrrs)
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>改变类型</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    changeType: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"type"</span>, type)
      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"category"</span>, <span class="hljs-keyword">this</span>.newrule[type])
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>几何计算</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    region: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, regionx1, regiony1, regionx2, regiony2, dx, dy</span>)</span>{
      <span class="hljs-keyword">var</span> maxX = regionx1 &gt;= regionx2 ? regionx1 : regionx2
        , minX = maxX == regionx1 ? regionx2 : regionx1
        , maxY = regiony1 &gt;= regiony2 ? regiony1 : regiony2
        , minY = maxY == regiony1 ? regiony2 : regiony1
        
      <span class="hljs-keyword">return</span> x &lt;= maxX + dx &amp;&amp; y &lt;= maxY + dy &amp;&amp; x &gt;= minX - dx &amp;&amp; y &gt;= minY - dy
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>几何计算</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    kSimilar:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k</span>)</span>{
      <span class="hljs-keyword">var</span> k = <span class="hljs-built_in">Math</span>.abs(k) &gt; <span class="hljs-number">9999</span> ? (k &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">-10000</span> : <span class="hljs-number">10000</span>) : k
        , k = <span class="hljs-built_in">Math</span>.abs(k) &lt; <span class="hljs-number">0.0001</span> ? <span class="hljs-number">0.0001</span> : k
        
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(k.toFixed(<span class="hljs-number">4</span>))
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>引用georule</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    retrRule: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) </span>{
      
      <span class="hljs-keyword">var</span> newrule = <span class="hljs-keyword">this</span>.newrule
        , georule = <span class="hljs-keyword">this</span>.georule

      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"category"</span>: newrule[type]
        , <span class="hljs-string">"geodata"</span>: georule[newrule[type]]
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>清除之前的数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearAtrrs: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, type</span>) </span>{
 
      <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"move"</span>) <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>改变type时，清除之前的几何数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> clear = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>) </span>{
        <span class="hljs-keyword">this</span>.unset(value, {
          silent: <span class="hljs-literal">true</span>
        });
      }.bind(<span class="hljs-keyword">this</span>)

      _.each([<span class="hljs-string">"x"</span>, <span class="hljs-string">"x2"</span>, <span class="hljs-string">"y"</span>, <span class="hljs-string">"y2"</span>, <span class="hljs-string">"angle"</span>, <span class="hljs-string">"barlength"</span>,<span class="hljs-string">"bodys"</span>,<span class="hljs-string">"connects"</span>], clear);
    },

    passMaker: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">geo</span>) </span>{      
      <span class="hljs-keyword">return</span> _.isUndefined(<span class="hljs-keyword">this</span>.get(geo)) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
    },

    geoGet: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">geo</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(geo)
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>防止在连在同一根杆上的约束与该杆杆身间再添加新杆</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    barbar: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) </span>{

      <span class="hljs-keyword">var</span> bar = _.filter(drawC.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
        <span class="hljs-keyword">if</span> (model.get(<span class="hljs-string">"category"</span>) == <span class="hljs-string">"bar"</span>) {
          <span class="hljs-keyword">var</span> x1 = model.get(<span class="hljs-string">"x"</span>)
            , y1 = model.get(<span class="hljs-string">"y"</span>)
            , x2 = model.get(<span class="hljs-string">"x2"</span>)
            , y2 = model.get(<span class="hljs-string">"y2"</span>)

          <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.region(x, y, x1, y1, x2, y2, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
        }
      }.bind(<span class="hljs-keyword">this</span>));

      bar = _.map(bar, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
        <span class="hljs-keyword">return</span> model.get(<span class="hljs-string">"order"</span>);
      });

      <span class="hljs-keyword">return</span> bar ? bar : []
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>防止在连在同一根杆上的约束间再添加新杆</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    barconstr: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, order</span>) </span>{

      <span class="hljs-keyword">var</span> constr = _.find(drawC.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
        <span class="hljs-keyword">var</span> category = model.get(<span class="hljs-string">"category"</span>)
          , x1 = model.get(<span class="hljs-string">"x"</span>)
          , y1 = model.get(<span class="hljs-string">"y"</span>)

        <span class="hljs-keyword">return</span> category == <span class="hljs-string">"constr"</span> &amp;&amp; x1 == x &amp;&amp; y1 == y
      }.bind(<span class="hljs-keyword">this</span>))

      <span class="hljs-keyword">if</span> (constr) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>最新添加的杆不参与计算 ** shallow copy will change the backbone array element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> connects = []
        
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; constr.get(<span class="hljs-string">"connects"</span>); i++) {
          <span class="hljs-keyword">if</span> (constr.get(<span class="hljs-string">"connects"</span>)[i] !== order){
            connects.push(constr.get(<span class="hljs-string">"connects"</span>)[i])
          }
        }

        connects = _.filter(connects,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connect</span>)</span>{ <span class="hljs-keyword">return</span> !_.isUndefined(connect) })

        <span class="hljs-keyword">return</span> connects
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> []
      }

    },

    passlineMaker: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x1, y1, x2, y2, order</span>) </span>{

      <span class="hljs-keyword">var</span> pass = _.every(drawC.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
        <span class="hljs-keyword">if</span> (model.get(<span class="hljs-string">"category"</span>) == <span class="hljs-string">"constr"</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

        <span class="hljs-keyword">var</span> mx1 = model.get(<span class="hljs-string">"x"</span>)
          , my1 = model.get(<span class="hljs-string">"y"</span>)
          , mx2 = model.get(<span class="hljs-string">"x2"</span>)
          , my2 = model.get(<span class="hljs-string">"y2"</span>)

        <span class="hljs-keyword">return</span> (x1 == mx1 &amp;&amp; y1 == my1 &amp;&amp; x2 == mx2 &amp;&amp; y2 == my2) || (x1 == mx2 &amp;&amp; y1 == my2 &amp;&amp; x2 == mx1 &amp;&amp; y2 == my1) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>

      }.bind(<span class="hljs-keyword">this</span>))
      
      <span class="hljs-keyword">if</span> (!pass) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

      <span class="hljs-keyword">if</span> (_.intersection(<span class="hljs-keyword">this</span>.barconstr(x1, y1, order), <span class="hljs-keyword">this</span>.barconstr(x2, y2, order)).length &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.barconstr(x1, y1, order).length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> _.intersection(<span class="hljs-keyword">this</span>.barbar(x2, y2), <span class="hljs-keyword">this</span>.barconstr(x1, y1)).length &gt; <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.barconstr(x2, y2, order).length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> _.intersection(<span class="hljs-keyword">this</span>.barbar(x1, y1), <span class="hljs-keyword">this</span>.barconstr(x2, y2)).length &gt; <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>生成绘图及之后计算的数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    drawelement: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"type"</span>)
        , retr = <span class="hljs-keyword">this</span>.retrRule(type)
        , geodata = retr[<span class="hljs-string">"geodata"</span>]
        , category = retr[<span class="hljs-string">"category"</span>]
        , geobj = {
          type: type
          , category: category
        }
        , isgh = (type == <span class="hljs-string">"gdj"</span> || type == <span class="hljs-string">"hdj"</span>)
        , isconstr = (category == <span class="hljs-string">"constr"</span>)
        , k = isgh ? <span class="hljs-built_in">Math</span>.tan((<span class="hljs-keyword">this</span>.get(<span class="hljs-string">"angle"</span>) - <span class="hljs-number">90</span>) / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI) : <span class="hljs-built_in">Math</span>.tan((<span class="hljs-keyword">this</span>.get(<span class="hljs-string">"angle"</span>)) / <span class="hljs-number">180</span> * <span class="hljs-built_in">Math</span>.PI)
        , k = <span class="hljs-keyword">this</span>.kSimilar(k)
        , order = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">"order"</span>)

      <span class="hljs-keyword">if</span> (!_.every(geodata, <span class="hljs-keyword">this</span>.passMaker.bind(<span class="hljs-keyword">this</span>))) <span class="hljs-keyword">return</span>

      $(<span class="hljs-string">"input"</span>).val(<span class="hljs-string">""</span>)

      _.extend(geobj
        , _.object(geodata
          , _.map(geodata
            , <span class="hljs-keyword">this</span>.geoGet.bind(<span class="hljs-keyword">this</span>)
          )
        )
      )

      <span class="hljs-keyword">if</span> (isconstr) {
        geobj.k = k

        <span class="hljs-keyword">this</span>.changeType(<span class="hljs-string">"linebar"</span>)

        <span class="hljs-keyword">this</span>.set({
          <span class="hljs-string">"x"</span>: geobj.x
          , <span class="hljs-string">"y"</span>: geobj.y
        })

        geobj.p1 = <span class="hljs-string">"x"</span> + geobj.x + <span class="hljs-string">"y"</span> + geobj.y
        geobj.p2 = <span class="hljs-literal">null</span> 
      
        <span class="hljs-keyword">if</span> (category == <span class="hljs-string">"constr"</span>){
          nomoM.insertdj(geobj.p1,<span class="hljs-string">"head"</span>)
            
          <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"hdj"</span>){
            nomoM.inserthdj(geobj.p1,<span class="hljs-string">"head"</span>)
          }
          
          <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"gdj"</span>|| type == <span class="hljs-string">"hdj"</span>|| type == <span class="hljs-string">"gdd"</span>|| type == <span class="hljs-string">"dxj"</span>){
            nomoM.insertzz(geobj.p1,<span class="hljs-string">"head"</span>)
          }
        }
   
        drawC.create(geobj)
      }

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.passlineMaker.bind(<span class="hljs-keyword">this</span>)(geobj.x, geobj.y, geobj.x2, geobj.y2, order)) <span class="hljs-keyword">return</span>
 
      geobj.k = <span class="hljs-keyword">this</span>.kSimilar((geobj.y2 - geobj.y) / (geobj.x2 - geobj.x))
      geobj.b = geobj.y - geobj.x * geobj.k
      geobj.p1 = <span class="hljs-string">"x"</span> + geobj.x + <span class="hljs-string">"y"</span> + geobj.y
      geobj.p2 = <span class="hljs-string">"x"</span> + geobj.x2 + <span class="hljs-string">"y"</span> + geobj.y2 

      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"bodys"</span>,[])
      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">"connects"</span>,[])</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>增加新的drawC model，将会触发canvas view的绘图事件</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      drawC.create(geobj)
    }

  }))()
})</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
